{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Remote Messaging Configuration",
  "description": "JSON schema for DuckDuckGo remote messaging configuration",
  "type": "object",
  "required": ["version", "messages", "rules"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "integer",
      "description": "Configuration version number"
    },
    "messages": {
      "type": "array",
      "description": "Array of remote messages",
      "items": {
        "$ref": "#/definitions/RemoteMessage"
      }
    },
    "rules": {
      "type": "array",
      "description": "Array of matching rules",
      "items": {
        "$ref": "#/definitions/MatchingRule"
      }
    }
  },
  "definitions": {
    "RemoteMessage": {
      "type": "object",
      "required": ["id", "content"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message"
        },
        "surfaces": {
          "type": "array",
          "description": "Surfaces the message can appear on",
          "items": {
            "$ref": "#/definitions/SurfaceType"
          }
        },
        "content": {
          "$ref": "#/definitions/MessageContent"
        },
        "translations": {
          "type": "object",
          "description": "Localized content translations",
          "patternProperties": {
            "^[a-z]{2}(?:-[A-Z]{2})?$": {
              "$ref": "#/definitions/ContentTranslation"
            }
          },
          "additionalProperties": false
        },
        "matchingRules": {
          "type": "array",
          "description": "Array of rule IDs that must match for this message to be shown",
          "items": {
            "type": "integer"
          }
        },
        "exclusionRules": {
          "type": "array",
          "description": "Array of rule IDs that must not match for this message to be shown",
          "items": {
            "type": "integer"
          }
        },
        "metrics": {
          "$ref": "#/definitions/Metrics"
        }
      }
    },
    "MessageContent": {
      "type": "object",
      "required": ["messageType", "titleText", "descriptionText"],
      "additionalProperties": false,
      "properties": {
        "messageType": {
          "$ref": "#/definitions/MessageType",
          "description": "Type of message to display"
        },
        "titleText": {
          "type": "string",
          "minLength": 1,
          "description": "Title text for the message"
        },
        "descriptionText": {
          "type": "string",
          "minLength": 1,
          "description": "Description text for the message"
        },
        "placeholder": {
          "$ref": "#/definitions/PlaceholderType",
          "description": "Placeholder type for the message"
        },
        "actionText": {
          "type": "string",
          "description": "Text for the action button (used in promo_single_action)"
        },
        "action": {
          "$ref": "#/definitions/MessageAction",
          "description": "Action for the button (used in promo_single_action)"
        },
        "primaryActionText": {
          "type": "string",
          "description": "Text for the primary action button (used in big_single_action and big_two_action)"
        },
        "primaryAction": {
          "$ref": "#/definitions/MessageAction",
          "description": "Primary action (used in big_single_action and big_two_action)"
        },
        "secondaryActionText": {
          "type": "string",
          "description": "Text for the secondary action button (used in big_two_action)"
        },
        "secondaryAction": {
          "$ref": "#/definitions/MessageAction",
          "description": "Secondary action (used in big_two_action)"
        },
        "listItems": {
          "type": "array",
          "description": "List items for cards_list message type",
          "items": {
            "$ref": "#/definitions/ListItem"
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "messageType": { "const": "big_single_action" } },
            "required": ["messageType"]
          },
          "then": {
            "required": ["primaryActionText", "primaryAction"]
          }
        },
        {
          "if": {
            "properties": { "messageType": { "const": "big_two_action" } },
            "required": ["messageType"]
          },
          "then": {
            "required": ["primaryActionText", "primaryAction", "secondaryActionText", "secondaryAction"]
          }
        },
        {
          "if": {
            "properties": { "messageType": { "const": "promo_single_action" } },
            "required": ["messageType"]
          },
          "then": {
            "required": ["actionText", "action"]
          }
        },
        {
          "if": {
            "properties": { "messageType": { "const": "cards_list" } },
            "required": ["messageType"]
          },
          "then": {
            "required": ["listItems", "primaryActionText", "primaryAction"]
          }
        }
      ]
    },
    "ListItem": {
      "type": "object",
      "required": ["id", "type", "titleText"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the list item"
        },
        "type": {
          "type": "string",
          "enum": ["two_line_list_item"],
          "description": "Type of list item"
        },
        "titleText": {
          "type": "string",
          "minLength": 1,
          "description": "Title text for the list item"
        },
        "descriptionText": {
          "type": "string",
          "description": "Description text for the list item"
        },
        "placeholder": {
          "$ref": "#/definitions/PlaceholderType",
          "description": "Placeholder for the list item"
        },
        "primaryAction": {
          "$ref": "#/definitions/MessageAction",
          "description": "Primary action for the list item"
        },
        "matchingRules": {
          "type": "array",
          "description": "Array of rule IDs that must match for this list item to be shown",
          "items": {
            "type": "integer"
          }
        },
        "exclusionRules": {
          "type": "array",
          "description": "Array of rule IDs that must not match for this list item to be shown",
          "items": {
            "type": "integer"
          }
        }
      }
    },
    "MessageAction": {
      "type": "object",
      "required": ["type", "value"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "$ref": "#/definitions/ActionType",
          "description": "Type of action to perform"
        },
        "value": {
          "type": "string",
          "description": "Value for the action (URL, navigation target, etc.)"
        },
        "additionalParameters": {
          "type": "object",
          "description": "Additional parameters for the action",
          "additionalProperties": false,
          "properties": {
            "title": {
              "type": "string",
              "description": "Title for share action"
            },
            "queryParams": {
              "type": "string",
              "description": "Semicolon-separated query parameters for survey action"
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "navigation"
              }
            },
            "required": [
              "type"
            ]
          },
          "then": {
            "properties": {
              "value": {
                "$ref": "#/definitions/NavigationTarget"
              }
            }
          }
        }
      ]
    },
    "NavigationTarget": {
      "type": "string",
      "description": "Valid navigation targets for the navigation action type",
      "enum": ["duckai.settings", "settings", "feedback", "sync", "import.passwords", "appearance"]
    },
    "ContentTranslation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "messageType": {
          "$ref": "#/definitions/MessageType"
        },
        "titleText": {
          "type": "string"
        },
        "descriptionText": {
          "type": "string"
        },
        "actionText": {
          "type": "string",
          "description": "Text for the action button (used in promo_single_action translations)"
        },
        "primaryActionText": {
          "type": "string"
        },
        "secondaryActionText": {
          "type": "string"
        },
        "listItems": {
          "type": "object",
          "description": "Translations for list items in cards_list messages",
          "additionalProperties": {
            "$ref": "#/definitions/ListItemTranslation"
          }
        }
      }
    },
    "ListItemTranslation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "titleText": {
          "type": "string"
        },
        "descriptionText": {
          "type": "string"
        }
      }
    },
    "Metrics": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "state": {
          "type": "string",
          "enum": ["disabled", "enabled"],
          "description": "Metrics collection state"
        }
      }
    },
    "MatchingRule": {
      "type": "object",
      "required": ["id", "attributes"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "integer",
          "description": "Unique identifier for the rule"
        },
        "targetPercentile": {
          "$ref": "#/definitions/TargetPercentile"
        },
        "attributes": {
          "type": "object",
          "description": "Matching attributes for the rule",
          "properties": {
            "locale": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "osApi": { "$ref": "#/definitions/StringRangeAttribute" },
            "formFactor": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "isInternalUser": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "appId": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "appVersion": { "$ref": "#/definitions/StringRangeAttribute" },
            "atb": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "appAtb": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "searchAtb": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "expVariant": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "emailEnabled": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "widgetAdded": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "bookmarks": { "$ref": "#/definitions/NumericRangeAttribute" },
            "favorites": { "$ref": "#/definitions/NumericRangeAttribute" },
            "appTheme": { "$ref": "#/definitions/SingleValueStringAttribute" },
            "daysSinceInstalled": { "$ref": "#/definitions/NumericRangeAttribute" },
            "daysSinceNetPEnabled": { "$ref": "#/definitions/NumericRangeAttribute" },
            "pproEligible": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "pproSubscriber": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "pproDaysSinceSubscribed": { "$ref": "#/definitions/NumericRangeAttribute" },
            "pproDaysUntilExpiryOrRenewal": { "$ref": "#/definitions/NumericRangeAttribute" },
            "pproPurchasePlatform": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "pproSubscriptionStatus": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "interactedWithMessage": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "interactedWithDeprecatedMacRemoteMessage": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "installedMacAppStore": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "pinnedTabs": { "$ref": "#/definitions/NumericRangeAttribute" },
            "customHomePage": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "duckPlayerOnboarded": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "duckPlayerEnabled": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "messageShown": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "isCurrentFreemiumPIRUser": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "isCurrentPIRUser": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "allFeatureFlagsEnabled": { "$ref": "#/definitions/SingleValueStringArrayAttribute" },
            "subscriptionFreeTrialActive": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "syncEnabled": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "shouldShowWinBackOfferUrgencyMessage": { "$ref": "#/definitions/SingleValueBooleanAttribute" },
            "daysSinceDuckAiUsed": { "$ref": "#/definitions/NumericRangeAttribute" }
          },
          "additionalProperties": false
        }
      }
    },
    "TargetPercentile": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "before": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Target percentile threshold (0.0 to 1.0)"
        }
      }
    },
    "SingleValueStringAttribute": {
      "type": "object",
      "description": "Single value matching for string attributes",
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "string",
          "description": "Expected string value for matching"
        },
        "fallback": {
          "type": "boolean",
          "description": "Whether to use this as a fallback rule"
        }
      }
    },
    "SingleValueBooleanAttribute": {
      "type": "object",
      "description": "Single value matching for boolean attributes",
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "boolean",
          "description": "Expected boolean value for matching"
        },
        "fallback": {
          "type": "boolean",
          "description": "Whether to use this as a fallback rule"
        }
      }
    },
    "SingleValueStringArrayAttribute": {
      "type": "object",
      "description": "Single value matching for string array attributes",
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Expected array of string values for matching"
        },
        "fallback": {
          "type": "boolean",
          "description": "Whether to use this as a fallback rule"
        }
      }
    },
    "NumericRangeAttribute": {
      "type": "object",
      "description": "Numeric range matching for integer attributes",
      "additionalProperties": false,
      "properties": {
        "min": {
          "type": "integer",
          "description": "Minimum value for range matching"
        },
        "max": {
          "type": "integer",
          "description": "Maximum value for range matching"
        },
        "value": {
          "type": "integer",
          "description": "Specific value for exact matching (overrides min/max)"
        },
        "fallback": {
          "type": "boolean",
          "description": "Whether to use this as a fallback rule"
        }
      }
    },
    "VersionString": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:\\.(0|[1-9]\\d*))?$",
      "description": "Version string in format x.y.z or x.y.z.a where .a is optional (e.g., '1.0.0', '2.1.3.1')"
    },
    "StringRangeAttribute": {
      "type": "object",
      "description": "String range matching for version attributes",
      "additionalProperties": false,
      "properties": {
        "min": {
          "$ref": "#/definitions/VersionString",
          "description": "Minimum version for range matching"
        },
        "max": {
          "$ref": "#/definitions/VersionString",
          "description": "Maximum version for range matching"
        },
        "value": {
          "$ref": "#/definitions/VersionString",
          "description": "Specific version for exact matching (overrides min/max)"
        },
        "fallback": {
          "type": "boolean",
          "description": "Whether to use this as a fallback rule"
        }
      }
    },
    "PlaceholderType": {
      "type": "string",
      "enum": [
        "Announce",
        "DDGAnnounce",
        "CriticalUpdate",
        "AppUpdate",
        "MacComputer",
        "MacAndWindows",
        "NewForMacAndWindows",
        "PrivacyShield",
        "Duck.ai",
        "VisualDesignUpdate",
        "ImageAI",
        "Radar",
        "RadarCheckGreen",
        "RadarCheckPurple",
        "KeyImport",
        "MobileCustomization",
        "PIR",
        "Subscription"
      ]
    },
    "SurfaceType": {
      "type": "string",
      "enum": ["new_tab_page", "modal", "dedicated_tab", "tab_bar"]
    },
    "MessageType": {
      "type": "string",
      "enum": ["small", "medium", "big_single_action", "big_two_action", "promo_single_action", "cards_list"]
    },
    "ActionType": {
      "type": "string",
      "enum": ["share", "url", "url_in_context", "appstore", "dismiss", "survey", "navigation"]
    }
  }
}
