name: Download RMF Images from S3

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install

    - name: Download images from S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      run: |
        S3_PATH="remotemessaging/illustrations/"

        echo "Downloading from s3://${AWS_S3_BUCKET}/${S3_PATH}"
        aws s3 sync "s3://${AWS_S3_BUCKET}/${S3_PATH}" illustrations/ --delete

        echo "Downloaded files:"
        ls -lah illustrations/

    - name: Commit and push if changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add illustrations/

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Sync images from S3"
          git push
          echo "Changes committed and pushed"
        fi