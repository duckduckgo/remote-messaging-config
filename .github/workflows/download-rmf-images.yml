name: Download RMF Images from S3

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        fetch-depth: 0

    - name: Check for deleted illustrations in latest commit
      id: check_changes
      run: |
        # Check specifically for deleted files in the latest commit
        DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD -- illustrations/ || echo "")

        if [ -n "$DELETED_FILES" ]; then
          echo "has_deletions=true" >> $GITHUB_OUTPUT
          echo "Latest commit has deleted illustrations - skipping download to avoid conflicts"
          echo "Deleted files in latest commit:"
          echo "$DELETED_FILES"
        else
          echo "has_deletions=false" >> $GITHUB_OUTPUT
          echo "No deleted illustrations in latest commit - will sync from S3"
        fi

    - name: Download images from S3
      if: steps.check_changes.outputs.has_deletions == 'false'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      run: |
        S3_PATH="remotemessaging/illustrations/"

        echo "Downloading from s3://${AWS_S3_BUCKET}/${S3_PATH}"
        aws s3 sync "s3://${AWS_S3_BUCKET}/${S3_PATH}" illustrations/ --delete

        echo "Downloaded files:"
        ls -lah illustrations/

    - name: Commit and push if changes
      if: steps.check_changes.outputs.has_deletions == 'false'
      id: commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add illustrations/

        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          git commit -m "Sync images from S3"
          git push
          echo "Changes committed and pushed"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Comment on PR
      if: steps.check_changes.outputs.has_deletions == 'false' && steps.commit.outputs.changes == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body "Images have been synced from the S3 bucket to match the latest commit."