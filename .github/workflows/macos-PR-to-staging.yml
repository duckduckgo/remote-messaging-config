name: PR to staging (macOS)

on:
  pull_request:
    paths:
      - 'live/macos-config/macos-config.json'
      - 'schemas/macos/schema.json'

env:
  CONFIG_FILE: 'live/macos-config/macos-config.json'
  SCHEMA_FILE: 'schemas/macos/schema.json'

jobs:
  validate:
    name: Validate Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JSON and check version
        id: validate
        run: ./.github/scripts/validate-config.sh "$CONFIG_FILE" "$SCHEMA_FILE" main

      - name: Comment PR with error details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const errorType = process.env.VALIDATION_ERROR;
            const errorMessage = process.env.ERROR_MESSAGE;
            const marker = '<!-- rmf-validation:macos -->';
            
            let title = '### ❌ Validation Failed\n\n';
            let body = '';
            
            switch(errorType) {
              case 'schema':
                body = `**JSON Schema Validation Error**\n\n`;
                body += 'Your JSON file does not match the required schema:\n\n';
                body += '```\n' + errorMessage + '\n```\n\n';
                body += '**How to fix:**\n';
                body += '1. Check the error message above\n';
                body += `2. Validate locally: \`./.github/scripts/validate-config.sh ${process.env.CONFIG_FILE} ${process.env.SCHEMA_FILE} main\`\n`;
                break;
            
              case 'version':
                body = `**Version Not Incremented**\n\n`;
                body += '⚠️ ' + errorMessage + '\n\n';
                body += '**How to fix:**\n';
                body += 'Increment the version number in the JSON config file\n';
                break;
            
              case 'rules':
                body = `**Invalid Rule References**\n\n`;
                body += 'Some messages reference rule IDs that don\'t exist:\n\n';
                body += '```\n' + errorMessage + '\n```\n\n';
                body += '**How to fix:**\n';
                body += '1. Check the rule IDs in your matchingRules/exclusionRules\n';
                body += '2. Ensure all referenced rules exist in the rules array\n';
                break;

              case 'orphan_rules':
                body = `**Orphaned Rules**\n\n`;
                body += 'Some rules are defined but never referenced by any message:\n\n';
                body += '```\n' + errorMessage + '\n```\n\n';
                body += '**How to fix:**\n';
                body += '1. Remove the unused rule(s), or\n';
                body += '2. Reference them from a message\'s matchingRules/exclusionRules\n';
                break;

              default:
                body = `**Validation Error**\n\n`;
                body += (errorMessage ? ('```\n' + errorMessage + '\n```\n\n') : '');
                body += 'See job logs for details.\n';
                break;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;
            const commentBody = `${marker}\n${title}${body}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find(c => (c.body || '').includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: commentBody
              });
            }

      - name: Update PR comment on success (sticky)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- rmf-validation:macos -->';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const commentBody =
              `${marker}\n` +
              `### ✅ Validation Passed\n\n` +
              `Config validated successfully.\n\n` +
              `- Config: \`${process.env.CONFIG_FILE}\`\n` +
              `- Schema: \`${process.env.SCHEMA_FILE}\`\n` +
              `- Run: ${runUrl}\n`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find(c => (c.body || '').includes(marker));
            if (!existing) {
              return;
            }

            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: existing.id,
              body: commentBody
            });

  publish:
    name: Publish to Staging
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync to S3 staging
        uses: jakejarvis/s3-sync-action@7ed8b112447abb09f1da74f3466e4194fc7a6311
        with:
          args: --acl public-read --follow-symlinks
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SOURCE_DIR: 'live/macos-config'
          DEST_DIR: 'remotemessaging/config/staging'

      - name: Comment on PR with staging URL
        uses: github-actions-up-and-running/pr-comment@f1f8ab2bf00dce6880a369ce08758a60c61d6c0b
        if: github.event.action == 'opened'
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          message: |
            ✅ Config validation passed!
            
            Your PR config is hosted at:
            https://staticcdn.duckduckgo.com/remotemessaging/config/staging/macos-config.json
